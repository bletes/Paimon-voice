# -*- coding: utf-8 -*-
"""VITS-Paimon-Inference

Automatically generated by Colaboratory.

Original file is located at
    https://colab.research.google.com/drive/1HDV84t3N-yUEBXN8dDIDSv6CzEJykCLw

# **æ´¾è’™è¯­éŸ³åˆæˆ**

![paimon](https://raw.githubusercontent.com/JOETtheIV/vits-mandarin-biaobei/main/IMG_9368.PNG)

ä½œè€…ï¼šVentiJ

é‚®ç®±ï¼šjoeyventicup@gmail.com

å­¦æ ¡ï¼šWHU

QQï¼š2997685348

Bç«™ï¼šhttps://www.bilibili.com/video/BV16G4y1B7Ey?spm_id_from=333.999.0.0&vd_source=5cf950fe9d9124a5fef05e9037c07db7

é¡¹ç›®ä»£ç ï¼šhttps://github.com/JOETtheIV/VITS-Paimon

# é…ç½®ç¯å¢ƒ

è¯·å…ˆç‚¹å‡»å³ä¸Šè§’çš„**è¿æ¥**ï¼Œè·å–GPUè¿ç®—èµ„æºã€‚

ç‚¹å‡»æ›´æ”¹è¿è¡Œæ—¶ç±»å‹ï¼ˆchange runtime typeï¼‰
å°†ç¡¬ä»¶åŠ é€Ÿå™¨æ”¹ä¸ºGPU


ç„¶åè¿è¡Œè¯¥ä»£ç å—ã€‚å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿâ€¦â€¦
"""

# Commented out IPython magic to ensure Python compatibility.
##!git clone https://github.com/JOETtheIV/VITS-Paimon
### %cd /content/VITS-Paimon
##!pip install -r requirements.txt
##!sudo apt-get install espeak -y
##
### %cd /content/VITS-Paimon/monotonic_align
##!python setup.py build_ext --inplace
### %cd ..
##!mkdir results
##
### Commented out IPython magic to ensure Python compatibility.
import os
path = r"C:\Users\HP\Downloads\VITS-Paimon\content\VITS-Paimon"
os.chdir(path)
print(os.getcwd())

# %matplotlib inline
import matplotlib.pyplot as plt
import IPython.display as ipd

import os
import json
import math
import torch
from torch import nn
from torch.nn import functional as F
from torch.utils.data import DataLoader

import commons
import utils
from data_utils import TextAudioLoader, TextAudioCollate, TextAudioSpeakerLoader, TextAudioSpeakerCollate
from models import SynthesizerTrn
from text.symbols import symbols
from text import text_to_sequence

from scipy.io.wavfile import write


def get_text(text, hps):
    text_norm = text_to_sequence(text, hps.data.text_cleaners)
    if hps.data.add_blank:
        text_norm = commons.intersperse(text_norm, 0)
    text_norm = torch.LongTensor(text_norm)
    return text_norm

"""# åŠ è½½æ¨¡å‹ ï¼ˆæ›´æ–°è‡³1700 epochs)


å¦‚é‡åˆ°ä¸‹è½½äººæ•°è¿‡å¤šå¯¼è‡´ä¸‹è½½å¤±è´¥çš„æƒ…å†µ

è¯·ç¨å®‰å‹¿èº å°†äºæ™šç‚¹ä¿®å¤

ç‚¹å‡»è¿è¡ŒMEGA public link download åŠ è½½æ¨¡å‹

### **ğŸ¥³æ›´æ–°**

æœ¬æ¥ä»¥ä¸ºæ´¾è’™è¯­éŸ³åˆ°ä¸€å®šç¨‹åº¦å†è®­ç»ƒä¸‹å»å¯¹è´¨é‡æå‡ä¸å¤§


ä½†æœ€æ–°çš„1700ä¸ªepochçš„æ¨¡å‹ç›¸æ¯”ä¹‹å‰æœ‰äº†æ›´ç»†è…»çš„ä¼˜åŒ–
"""

import sys, os, urllib.request
import time
import subprocess
import contextlib
from IPython.display import clear_output
#@markdown <br><center><img src='https://mega.nz/favicon.ico?v=3' height="50" alt="MEGA-logo"/></center>
#@markdown <center><h2>Transfer from Mega to GDrive</h2></center><br>
HOME = os.path.expanduser("~")
##if not os.path.exists(f"{HOME}/.ipython/ocr.py"):
##    hCode = "https://raw.githubusercontent.com/biplobsd/" \
##                "OneClickRun/master/res/ocr.py"
##    urllib.request.urlretrieve(hCode, f"{HOME}/.ipython/ocr.py")

##from ocr import (
##    runSh,
##    loadingAn,
##)
#@title MEGA public link download
URL = "https://mega.nz/file/4f0CgBaT#Hu4h_ZhVDC6V4RaS9zUeEJJY9cniqKx911z8duPSfCw" #@param {type:"string"}
OUTPUT_PATH = "/content/VITS-Paimon" #@param {type:"string"}
#@markdown #####_*Sometimes this cell doesn't stop itself after the completion of the transfer. In case of that stop the cell manually._
if not OUTPUT_PATH:
  os.makedirs("downloads", exist_ok=True)
  OUTPUT_PATH = "downloads"
# MEGAcmd installing
##if not os.path.exists("/usr/bin/mega-cmd"):
##    loadingAn()
##    print("Installing MEGA ...")
##    runSh('sudo apt-get -y update')
##    runSh('sudo apt-get -y install libmms0 libc-ares2 libc6 libcrypto++6 libgcc1 libmediainfo0v5 libpcre3 libpcrecpp0v5 libssl1.1 libstdc++6 libzen0v5 zlib1g apt-transport-https')
##    runSh('sudo curl -sL -o /var/cache/apt/archives/MEGAcmd.deb https://mega.nz/linux/MEGAsync/Debian_9.0/amd64/megacmd-Debian_9.0_amd64.deb', output=True)
##    runSh('sudo dpkg -i /var/cache/apt/archives/MEGAcmd.deb', output=True)
##    print("MEGA is installed.")
##    clear_output()

# Unix, Windows and old Macintosh end-of-line
newlines = ['\n', '\r\n', '\r']

def unbuffered(proc, stream='stdout'):
    stream = getattr(proc, stream)
    with contextlib.closing(stream):
        while True:
            out = []
            last = stream.read(1)
            # Don't loop forever
            if last == '' and proc.poll() is not None:
                break
            while last not in newlines:
                # Don't loop forever
                if last == '' and proc.poll() is not None:
                    break
                out.append(last)
                last = stream.read(1)
            out = ''.join(out)
            yield out


def transfare():
    import codecs
    decoder = codecs.getincrementaldecoder("UTF-8")()
    cmd = ["mega-get", URL, OUTPUT_PATH]
    proc = subprocess.Popen(
        cmd,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        # Make all end-of-lines '\n'
        universal_newlines=True,
    )
    for line in unbuffered(proc):
        print(line)
        


##transfare()

"""# è¯­éŸ³åˆæˆ

ä½ è¿˜å¯ä»¥é€šè¿‡è°ƒèŠ‚`length_scale`æ¥æ§åˆ¶è¯´è¯çš„é€Ÿåº¦ï¼æ³¨æ„`length_scale`é»˜è®¤å€¼ä¸º1.0ï¼Œå€¼è¶Šå¤§è¯´è¯è¶Š**æ…¢**ã€‚

**Tips**

1. æµ‹è¯•å‘ç°å¤ªé•¿æˆ–å¤ªçŸ­çš„å¥å­æ•ˆæœéƒ½ä¸å¤ªå¥½ï¼Œå‚è€ƒæ–‡æœ¬å»ºè®®åˆ†å¥ä½¿ç”¨ã€‚
2. ã€Œã€ã€çš„åœé¡¿æ•ˆæœä¸æ˜¯å¾ˆç†æƒ³ï¼Œå»ºè®®ä½¿ç”¨ã€Œã€‚ã€æˆ–ã€Œâ€¦ã€ã€‚
3. ç”±äºæ•°æ®é›†ä¸­å»æ‰äº†å¤§éƒ¨åˆ†Hç‰‡æ®µï¼Œä½™ä¸‹æ•°æ®é‡Œå„ä¸ªäººç‰©è¯´è¯çš„è¯­è°ƒéƒ½æ¯”è¾ƒå¹³ç¨³ã€‚å› æ­¤ä½¿ç”¨ã€Œï¼ã€å¯èƒ½ä¼šå‡ºç°ç ´éŸ³ã€‚

ä¸ºç”Ÿåˆæˆçš„è¯­éŸ³è®¾å®šä¸€ä¸ªæ–‡ä»¶åã€‚æ³¨æ„ä¸éœ€è¦åŠ æ‰©å±•åï¼

å‘½ååè¿è¡Œè¯¥ä»£ç å—ï¼Œä½ å°†åœ¨å·¦ä¾§æ–‡ä»¶ç³»ç»Ÿä¸­/content/vits-mandarin-biaobei/test.wavæ‰¾åˆ°å®ƒï¼
"""

hps = utils.get_hparams_from_file("./configs/biaobei_base.json")
device = torch.device("cuda:0" if torch.cuda.is_available() else "cpu") # å•GPUæˆ–è€…CPU


net_g = SynthesizerTrn(len(symbols),hps.data.filter_length // 2 + 1,hps.train.segment_size // hps.data.hop_length,**hps.model).to(device)
_ = net_g.eval()

_ = utils.load_checkpoint('G_1434000.pth', net_g, None)
import soundfile as sf
text = "\u4E0B\u9762\u7ED9\u5927\u5BB6\u7B80\u5355\u4ECB\u7ECD\u4E00\u4E0B\u600E\u4E48\u4F7F\u7528\u8FD9\u4E2A\u6559\u7A0B\u5427\uFF01\u9996\u5148\u6211\u4EEC\u8981\u6709\u9B54\u6CD5\uFF0C\u624D\u80FD\u8BBF\u95EE\u5230\u8C37\u6B4C\u7684\u4E91\u5E73\u53F0\u3002\u70B9\u51FB\u8FDE\u63A5\u5E76\u66F4\u6539\u8FD0\u884C\u65F6\u7C7B\u578B\uFF0C\u8BBE\u7F6E\u786C\u4EF6\u52A0\u901F\u5668\u4E3AGPU\u3002\u7136\u540E\uFF0C\u6211\u4EEC\u518D\u4ECE\u5934\u5230\u5C3E\u6328\u4E2A\u70B9\u51FB\u6BCF\u4E2A\u4EE3\u7801\u5757\u7684\u8FD0\u884C\u6807\u5FD7\u3002\u53EF\u80FD\u9700\u8981\u7B49\u5F85\u4E00\u5B9A\u7684\u65F6\u95F4\u3002\u5F53\u6211\u4EEC\u8FDB\u884C\u5230\u8BED\u97F3\u5408\u6210\u90E8\u5206\u65F6\uFF0C\u5C31\u53EF\u4EE5\u66F4\u6539\u8981\u8BF4\u7684\u6587\u672C\uFF0C\u5E76\u8BBE\u7F6E\u4FDD\u5B58\u7684\u6587\u4EF6\u540D\u5566\u3002" #@param {type: 'string'}
text=r'''æˆ‘å¸®æ‚¨åšä¸€ä¸‹è¿™ä¸ªèµ„æ–™æ”¶é›†ã€‚ä½ çœ‹ä¸€ä¸‹é¡µé¢ä¸Šï¼Œè¿™ä¸ªæ˜¯æˆ‘ä»¬åç»­éœ€è¦æ”¶é›†çš„ä¸€äº›ä¿¡æ¯ï¼Œé‚£æˆ‘è¿™è¾¹çš„è¯å¤§æ¦‚å…ˆè·Ÿæ‚¨è®²è§£ä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆè¦æ”¶é›†è¿™ä¸ªå†…å®¹ã€‚æ¯”æ–¹è¯´æ”¯å‡ºï¼Œæœ‰å¾ˆå¤šçš„å®¢æˆ·é—®æˆ‘ä¹°ä¿é™©æœ‰æ²¡æœ‰å¿…è¦æ¥å¯¹è¿™ä¸ªæ”¯å‡ºæ–¹é¢ä½œäº†è§£ï¼Œæˆ‘å‘Šè¯‰ä½ è¿™ä¸ªéå¸¸æœ‰å¿…è¦å› ä¸ºå®¢è§‚æ¥è®²çš„è¯ï¼Œæœªæ¥åç»­æ‰€æœ‰çš„è¿™ä¸ªä¿éšœï¼Œä»–ä¹°ä¿é™©çš„å¾ˆå¤§ä¸€ä¸ªç›®çš„æ˜¯å¸Œæœ›èƒ½å¤Ÿåœ¨å‡ºç°ä¸¥é‡æƒ…å†µçš„æ—¶å€™è´Ÿæ‹…ä½ æœªæ¥ä¸€æ®µæ—¶é—´å®¶åº­çš„å¼€é”€ï¼Œé‚£ä½ ç”Ÿæ´»æ°´å¹³ä¸ä¼šä¸‹é™ï¼Œæ‰€ä»¥åœ¨è¿™ç§æƒ…å†µä¸‹æˆ‘è‚¯å®šè¦éœ€è¦äº†è§£å½“ä¸‹ä½ çš„ä¸€ä¸ªæ•´ä¸ªçš„æ”¯å‡ºçš„çŠ¶å†µã€‚é‚£ä¹ˆåŒæ ·çš„ï¼Œæ”¶å…¥æƒ…å†µä¸‹é¢çš„è¯ï¼Œä»–å…ˆæ˜¯è·Ÿæ”¯å‡ºç›¸ç»“åˆçš„ï¼Œå› ä¸ºæˆ‘ä»¬æŠŠæ”¶å…¥å’Œæ”¯å‡ºç›¸å‡ï¼Œå°±èƒ½å¾—å‡ºæ‚¨å®¶åº­çš„è¯ï¼Œå¤§æ¦‚æ¯å¹´èƒ½å‰©å¤šå°‘é’±ï¼Œé‚£æœªæ¥çš„è¯æ‰€æœ‰çš„è§„åˆ’è‚¯å®šæ˜¯åœ¨ç»“ä½™é‡Œå¤´åšæ–‡ç« ã€‚é‚£åŒæ ·çš„èµ„äº§å’Œè´Ÿå€ºçš„é€»è¾‘ä¹Ÿæ˜¯ç›¸åŒçš„ï¼Œé‚£è¿™è¾¹éœ€è¦è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼Œæ”¯å‡ºå¾…ä¼šå„¿ä¼šå¾€å¤§äº†è¯´ï¼Œæ¯”æ–¹å¦‚æœä½ è¿™ä¸ªå¼€é”€300åˆ°500ï¼Œé‚£å¾ˆæœ‰å¯èƒ½æˆ‘ä»¬æœ€åæ”¶é›†çš„æ—¶å€™çš„è¯å¯èƒ½éœ€è¦æŒ‰ä¸Šé™æ¥æ”¶é›†ï¼Œå…·ä½“çš„ä½ ä¸ç”¨å‡†å¤‡ã€‚é‚£ä¹ˆèµ„äº§è´Ÿå€ºè¿™å—çš„è¯ï¼Œé€»è¾‘ä¸Šèµ„äº§æ˜¯å¾€ä¿å®ˆçš„è¯´ï¼Œè´Ÿå€ºçš„è¯è¦å¾€å¤šäº†è¯´ï¼Œé‚£çŸ­æœŸæ”¯å‡ºè®¡åˆ’è¿™å—çš„è¯è¿™ä¸ªå¯èƒ½æœ‰å¾ˆå¤šäººä¸æ¸…æ¥šä»–å¹²å˜›ç”¨ï¼Œå› ä¸ºæˆ‘ä¸¾ä¸ªä¾‹å­æ¯”æ–¹è¯´ï¼Œå¦‚æœæœ‰äº›å®¶åº­ä»–ä»Šå¹´å†…è¦ä¹°æˆ¿çš„è¯ï¼Œå¯èƒ½ä¼šåŠ¨ç”¨åˆ°åŸå…ˆè¿™ä¸ªé‡Œå¤´çš„ä¸€äº›ç§¯è“„å¯¹ä¸å¯¹ï¼Œé‚£ä¹ˆå¯èƒ½å°±ä¼šå½±å“åˆ°åŸå…ˆæˆ‘ä»¬ç»Ÿè®¡èµ„äº§è´Ÿå€ºçš„æ•°å­—ï¼Œæ‰€ä»¥æˆ‘éœ€è¦äº†è§£ä¸€ä¸‹ä½ çŸ­æœŸæœ‰æ²¡æœ‰ä¸€äº›å¤§é¢æ”¯å‡ºçš„ä¸€äº›å‡†å¤‡ã€‚ç„¶åè¿˜æœ‰å°±æ˜¯æ­£å¸¸ä¸‹é¢çš„è¿™ä¸ªå¥åº·çŠ¶å†µï¼Œè¿™ä¸ªçš„è¯æˆ‘æƒ³ä¸€èˆ¬çš„è¯ä¸ç”¨è§£é‡Šï¼Œä¹°ä¿é™©çš„è¯å¤šæ˜¯äº†è§£å¤§å®¶çš„ä¸€ä¸ªèº«ä½“æƒ…å†µï¼Œå¦‚æœæœ‰ä¸€äº›æ—¢å¾€çš„ä¸€äº›é—®é¢˜çš„è¯ï¼Œæœªæ¥åœ¨é€‰æ‹©äº§å“çš„æ—¶å€™ï¼ŒåŒ…æ‹¬å¯èƒ½æœ€ç»ˆè·Ÿä¿é™©å…¬å¸æ²Ÿé€šä¸Šéƒ½éœ€è¦åšé¢å¤–çš„å¤„ç†ï¼Œè¿™ä¸¤ä¸ªçš„è¯æ˜¯ä½ ä»¬ç°åœ¨ï¼Œæ‚¨ç°åœ¨å·²ç»æœ‰çš„ä¿é™©ã€‚è¿™ä¸ªå·²ç»æœ‰çš„ä¿é™©çš„è¯ï¼Œé™¤äº†æˆ‘ä»¬è¯´æ­£å¸¸çš„ç¤¾ä¿ï¼Œè¿˜åŒ…æ‹¬è¯´æ‚¨å•ä½çš„é‚£äº›ä¹°å›¢é™©ï¼Œé‚£å¦‚æœæ‚¨ä¹‹å‰æœ‰ä¹°è¿‡é‚£ä¸ªå•†ä¸šä¿é™©çš„è¯ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹Ÿéœ€è¦äº†è§£ï¼Œè¿™äº›äº‹æˆ‘å¾…ä¼šéœ€è¦é—®æ‚¨çš„ã€‚æ—¶é—´ä¸Šé¢çš„è¯å¤§æ¦‚æ˜¯åœ¨ä¸€ä¸ªå°æ—¶åˆ°ä¸€ä¸ªåŠå°æ—¶ï¼Œå…·ä½“çœ‹æ‚¨æƒ…å†µæ˜¯ä¸æ˜¯å¤æ‚ï¼Œå¦‚æœæ²¡æœ‰é—®é¢˜çš„è¯æˆ‘å°±å¼€å§‹å…·ä½“æ”¶é›†å•¦'''
length_scale = 1 #@param {type:"slider", min:0.1, max:3, step:0.05}
filename = 'test' #@param {type: "string"}
audio_path = f'{filename}.wav'
stn_tst = get_text(text, hps)
with torch.no_grad():
    x_tst = stn_tst.to(device).unsqueeze(0)
    x_tst_lengths = torch.LongTensor([stn_tst.size(0)]).to(device)
    audio = net_g.infer(x_tst, x_tst_lengths, noise_scale=.667, noise_scale_w=0.8, length_scale=length_scale)[0][0,0].data.cpu().float().numpy()
ipd.display(ipd.Audio(audio, rate=hps.data.sampling_rate))
sf.write(audio_path,audio,samplerate=hps.data.sampling_rate)

"""# å‚è€ƒ

https://github.com/jaywalnut310/vits

https://colab.research.google.com/drive/1eFmnzUU8OGMlKwFw4OJG23CmawF1_zKh?usp=sharing

"""
